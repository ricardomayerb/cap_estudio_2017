---
title: "Agrupando condiciones macro en AL"
author: "Ricardo Mayer"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 3
  pdf_document: default
  word_document: default
params:
  end_year: 2015
  start_year: 1990
  is_html: TRUE
always_allow_html: yes
---

```{r knit_config, include=FALSE}

knitr::opts_knit$set(root.dir = "./../")
knitr::opts_chunk$set(echo = TRUE)

```

```{r setup, include=FALSE}

source('./functions/break_down_table.R')
# source('V:/USR/RMAYER/cw/cap_estudio_2017/functions/break_down_table.R')
```


```{r libs_dicts_country_sel, include = FALSE}
library(printr)
library(plotly)
library(dygraphs)
library(tidyr)
library(dplyr)
library(tibble)
library(ggplot2)
library(stringr)
library(stringi)
library(DT)
library(lubridate)
library(ineq)
library(knitr)
library(xts)
library(purrr)

library(xtable)
options(xtable.floating = FALSE)
options(xtable.timestamp = "")
options(width = 60)
options(digits = 3)


load("./produced_data/cepal_19_countries")
load("./produced_data/cepal_33_countries")

coi_19 <- cepal_19_countries$iso3c
coi_18 <- coi_19[-which(coi_19 %in% c("CUB"))]
coi_18_minus_br_mx_ven <-  coi_18[-which(coi_18 %in% c("BRA", "MEX", "VEN"))]
coi_sa <-  c("ARG", "BOL" ,"BRA", "CHL", "COL", "ECU",  "PER", "PRY", "URY", "VEN")
coi_sa_minus_BRA_VEN <- coi_sa[-which(coi_sa %in% c("BRA","VEN"))]
coi_ca <-  c("CRI", "DOM", "HND" ,"GTM", "PAN", "NIC", "SLV", "MEX")
coi_ca_minus_mex <- coi_ca[-which(coi_ca %in% c("MEX"))]

coi <- coi_sa_minus_BRA_VEN

mr_year <- params$end_year

```


```{r source_dext_funcs}
source(file = "./functions/cate_dext.R")
```


# Debt
## Total external debt {.tabset .tabset-fade .tabset-pills}

```{r load_ext_debt_data}
load("./produced_data/data_with_basic_wrangling/cs_deuda_externa")
```

```{r ext_debt_make_dfs, echo=FALSE}
# make tibble for future tables and plots

dext_to_gdp <- cs_deuda_externa %>% 
  filter(str_detect(indicador, "porcentaje")) %>% 
  rename(deuda_ext_porc_pib = valor) %>% 
  select(iso3c, year, deuda_ext_porc_pib) %>% 
  mutate(year = as.Date(as.character(year), format = "%Y"))

dext_to_gdp_18 <- dext_to_gdp %>% 
  filter(iso3c %in% coi_18)

dext_to_gdp_18_m_bmv <- dext_to_gdp_18 %>% 
  filter(iso3c %in% coi_18_minus_br_mx_ven)

dext_to_gdp_sa <- dext_to_gdp_18 %>% 
  filter(iso3c %in% coi_sa)


dext_to_gdp_sa_mbv <- dext_to_gdp_sa %>% 
  filter(iso3c %in% coi_sa_minus_BRA_VEN)

dext_to_gdp_ca <- dext_to_gdp_18 %>% 
  filter(iso3c %in% coi_ca)

dext_to_gdp_ca_mm <- dext_to_gdp_ca %>% 
  filter(iso3c %in% coi_ca_minus_mex)

```

### Latin America


```{r ext_debt_make_ggplot_18, eval=FALSE, include=FALSE}
#using ggplot
dext_title <- "(Gross) External debt, as % of GDP (E18)"
g_18 <- ggplot(data = dext_to_gdp_18, aes(x = year, y = deuda_ext_porc_pib, color = iso3c)) + 
  geom_line() + ggtitle(dext_title, subtitle = "Countries: ECLAC 18")  

pl_18 <- ggplotly(g_18)
pl_18

```

```{r ext_debt_make_dygraph_18_18mbmv}
#using dygraph
dext_to_gdp_18_spread <- dext_to_gdp_18 %>% 
  spread(key = iso3c, value = deuda_ext_porc_pib)
dext_to_gdp_18_xts <- dext_to_gdp_18_spread %>% 
  select(-year) %>% 
  xts(order.by = dext_to_gdp_18_spread$year)

dext_to_gdp_18_spread_m_bmv <- dext_to_gdp_18_m_bmv %>% 
  spread(key = iso3c, value = deuda_ext_porc_pib)
dext_to_gdp_18_m_bmv_xts <- dext_to_gdp_18_spread_m_bmv %>% 
  select(-year) %>% 
  xts(order.by = dext_to_gdp_18_spread$year)

dext_title_18 <- "(Gross) External debt, as % of GDP (E18)"
dext_title_18mbmv <- "(Gross) External debt, as % of GDP (E18mBMV)"

dg_18 <- dygraph(dext_to_gdp_18_xts, main = dext_title_18) %>%
  dyRangeSelector() %>%
dyHighlight(highlightCircleSize = 4,
            highlightSeriesBackgroundAlpha = 0.3,
            hideOnMouseOut = FALSE)
dg_18

# dg_18_m_bmv <- dygraph(dext_to_gdp_18_m_bmv_xts, main = dext_title_18mbmv) %>%
#   dyRangeSelector() %>%
#   dyHighlight(highlightCircleSize = 4, 
#               highlightSeriesBackgroundAlpha = 0.3,
#               hideOnMouseOut = FALSE)
# dg_18_m_bmv

```



### South America

```{r ext_debt_make_dygraph_sa_sambv}
#using dygraph
dext_to_gdp_sa_spread <- dext_to_gdp_sa %>% 
  spread(key = iso3c, value = deuda_ext_porc_pib)
dext_to_gdp_sa_xts <- dext_to_gdp_sa_spread %>% 
  select(-year) %>% 
  xts(order.by = dext_to_gdp_sa_spread$year)

dext_to_gdp_sa_mbv_spread <- dext_to_gdp_sa_mbv %>% 
  spread(key = iso3c, value = deuda_ext_porc_pib)
dext_to_gdp_sambv_xts <- dext_to_gdp_sa_mbv_spread %>% 
  select(-year) %>% 
  xts(order.by = dext_to_gdp_sa_mbv_spread$year)

dext_title_sa <- "(Gross) External debt, as % of GDP (SA)"
dext_title_sambv <- "(Gross) External debt, as % of GDP (SAmBV)"

dg_sa <- dygraph(dext_to_gdp_sa_xts, main = dext_title_sa) %>%
dyRangeSelector() %>%
dyHighlight(highlightCircleSize = 4,
            highlightSeriesBackgroundAlpha = 0.3,
            hideOnMouseOut = FALSE)
dg_sa

# dg_sa_mbv <- dygraph(dext_to_gdp_sambv_xts, main = dext_title_sambv) %>%
#   dyRangeSelector() %>%
#   dyHighlight(highlightCircleSize = 4, 
#               highlightSeriesBackgroundAlpha = 0.3,
#               hideOnMouseOut = FALSE)
# dg_sa_mbv

```

### Central America

```{r ext_debt_make_dygraph_ca_camm}
dext_to_gdp_ca_spread <- dext_to_gdp_ca %>% 
  spread(key = iso3c, value = deuda_ext_porc_pib)
dext_to_gdp_ca_xts <- dext_to_gdp_ca_spread %>% 
  select(-year) %>% 
  xts(order.by = dext_to_gdp_ca_spread$year)

dext_to_gdp_ca_mm_spread <- dext_to_gdp_ca_mm %>% 
  spread(key = iso3c, value = deuda_ext_porc_pib)
dext_to_gdp_ca_mm_xts <- dext_to_gdp_ca_mm_spread %>% 
  select(-year) %>% 
  xts(order.by = dext_to_gdp_ca_mm_spread$year)

dext_title_ca <- "(Gross) External debt, as % of GDP (CA)"
dext_title_camm <- "(Gross) External debt, as % of GDP (CAmM)"

dg_ca <- dygraph(dext_to_gdp_ca_xts, main = dext_title_ca) %>%
dyRangeSelector() %>%
dyHighlight(highlightCircleSize = 4,
            highlightSeriesBackgroundAlpha = 0.3,
            hideOnMouseOut = FALSE)
dg_ca

# dg_ca_mm <- dygraph(dext_to_gdp_ca_mm_xts, main = dext_title_camm) %>%
#   dyRangeSelector() %>%
#   dyHighlight(highlightCircleSize = 4, 
#               highlightSeriesBackgroundAlpha = 0.3,
#               hideOnMouseOut = FALSE)
# dg_ca_mm

```


### Quantiles of indebtness {.tabset}


```{r dext_avg_pctile, echo=TRUE}

# sample of 18 countries:
dext_18_class_med_1990_2015 <- cate_dext(dext_to_gdp_18)
dext_18_class_pct3_1990_2015 <- cate_dext(dext_to_gdp_18, 
                                          is_med = FALSE, is_pct3 = TRUE)
dext_18_class_pct4_1990_2015 <- cate_dext(dext_to_gdp_18,
                                          is_med = FALSE, is_pct3 = FALSE,
                                          is_pct4 = TRUE)

dext_18_class_med_1990_2001_2015 <- cate_dext(dext_to_gdp_18,
                                              time_breaks = 2001)
dext_18_class_pct3_1990_2001_2015 <- cate_dext(dext_to_gdp_18, 
                                               time_breaks = 2001,
                                               is_med = FALSE,
                                               is_pct3 = TRUE)
dext_18_class_pct4_1990_2001_2015 <- cate_dext(dext_to_gdp_18,
                                               time_breaks = 2001,
                                               is_med = FALSE, is_pct3 = FALSE,
                                               is_pct4 = TRUE)

# sample of south american countries
dext_sa_class_med_1990_2015 <- cate_dext(dext_to_gdp_sa)
dext_sa_class_pct3_1990_2015 <- cate_dext(dext_to_gdp_sa, 
                                          is_med = FALSE, is_pct3 = TRUE)
dext_sa_class_pct4_1990_2015 <- cate_dext(dext_to_gdp_sa,
                                          is_med = FALSE, is_pct3 = FALSE,
                                          is_pct4 = TRUE)

dext_sa_class_med_1990_2001_2015 <- cate_dext(dext_to_gdp_sa,
                                              time_breaks = 2001)
dext_sa_class_pct3_1990_2001_2015 <- cate_dext(dext_to_gdp_sa, 
                                               time_breaks = 2001,
                                               is_med = FALSE,
                                               is_pct3 = TRUE)
dext_sa_class_pct4_1990_2001_2015 <- cate_dext(dext_to_gdp_sa,
                                               time_breaks = 2001,
                                               is_med = FALSE, is_pct3 = FALSE,
                                               is_pct4 = TRUE)

# sample of central american countries
dext_ca_class_med_1990_2015 <- cate_dext(dext_to_gdp_ca)
dext_ca_class_pct3_1990_2015 <- cate_dext(dext_to_gdp_ca, 
                                          is_med = FALSE, is_pct3 = TRUE)
dext_ca_class_pct4_1990_2015 <- cate_dext(dext_to_gdp_ca,
                                          is_med = FALSE, is_pct3 = FALSE,
                                          is_pct4 = TRUE)

dext_ca_class_med_1990_2001_2015 <- cate_dext(dext_to_gdp_ca,
                                              time_breaks = 2001)
dext_ca_class_pct3_1990_2001_2015 <- cate_dext(dext_to_gdp_ca, 
                                               time_breaks = 2001,
                                               is_med = FALSE,
                                               is_pct3 = TRUE)
dext_ca_class_pct4_1990_2001_2015 <- cate_dext(dext_to_gdp_ca,
                                               time_breaks = 2001,
                                               is_med = FALSE, is_pct3 = FALSE,
                                               is_pct4 = TRUE)

# iso_18_above_median_90_15 <-  dext_18_class_med_1990_2015 %>% 
#   filter(dext_group == "above_median") %>% select(iso3c) %>% distinct()
# 
# iso_18_below_median_90_15 <-  dext_18_class_med_1990_2015 %>% 
#   filter(dext_group == "below_median") %>% select(iso3c) %>% distinct()
```

```{r dext_avg_pctile_xts_wide}
dext_18_med_1990_2015_xts <- cate_dext_to_xts_wide(dext_18_class_med_1990_2015)
dext_18_pct3_1990_2015_xts <- cate_dext_to_xts_wide(dext_18_class_pct3_1990_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = TRUE)
dext_18_pct4_1990_2015_xts <- cate_dext_to_xts_wide(dext_18_class_pct4_1990_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = FALSE,
                                                      is_pct4 = TRUE)

dext_18_med_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_18_class_med_1990_2001_2015)
dext_18_pct3_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_18_class_pct3_1990_2001_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = TRUE)
dext_18_pct4_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_18_class_pct4_1990_2001_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = FALSE,
                                                      is_pct4 = TRUE)

dext_sa_med_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_sa_class_med_1990_2001_2015)
dext_sa_pct3_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_sa_class_pct3_1990_2001_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = TRUE)
dext_sa_pct4_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_sa_class_pct4_1990_2001_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = FALSE,
                                                      is_pct4 = TRUE)

dext_ca_med_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_ca_class_med_1990_2001_2015)
dext_ca_pct3_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_ca_class_pct3_1990_2001_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = TRUE)
dext_ca_pct4_1990_2001_2015_xts <- cate_dext_to_xts_wide(dext_ca_class_pct4_1990_2001_2015,
                                                      is_med = FALSE,
                                                      is_pct3 = FALSE,
                                                      is_pct4 = TRUE)

```


#### ALC three quantiles 
```{r  dext_avg_pctile3_dygraph, echo=TRUE}
# using 2001 as a time break, pct33 and pct66
dg_dext_18_pct3_1990_2001_2015 <- purrr::map(dext_18_pct3_1990_2001_2015_xts,
                                             dygraph)


dg_dext_18_pct3_1990_2015 <- purrr::map(dext_18_pct3_1990_2015_xts,
                                             dygraph)
dg_dext_18_pct3_1990_2015[[3]] %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE)


### Based on 1990-2001, 2002-2015 averages
```

```{r dext_to_gdp_1990_2002_2015}
source('./functions/break_down_table.R')
dext_18_avg_1990_2001 <- dext_to_gdp_18 %>%
  filter(year(year) >= 1990 & year(year) <= 2001) %>% 
  group_by(iso3c) %>% 
  summarise(dext_avg_1990_2001 = mean(deuda_ext_porc_pib, rm.na = TRUE))

pctiles_50_1990_2001 <-  quantile(dext_18_avg_1990_2001$dext_avg_1990_2001,
                                  probs = c(0.5))


dg_dext_18_pct3_1990_2015[[2]] %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE)

dg_dext_18_pct3_1990_2015[[1]] %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE)

```

#### ALC four quantiles
```{r  dext_avg_pctile4_dygraph, echo=TRUE}
# using 2001 as a time break, pct33 and pct66
# dg_dext_18_pct4_1990_2001_2015 <- purrr::map(dext_18_pct3_1990_2001_2015_xts,
#                                              dygraph)

dg_dext_18_pct4_1990_2015 <- purrr::map(dext_18_pct4_1990_2015_xts,
                                             dygraph)
dg_dext_18_pct4_1990_2015[[4]] %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE)

dg_dext_18_pct4_1990_2015[[3]] %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE)

dg_dext_18_pct4_1990_2015[[2]] %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE)

dg_dext_18_pct4_1990_2015[[1]] %>% dyRangeSelector() %>%
  dyHighlight(highlightCircleSize = 5, 
              highlightSeriesBackgroundAlpha = 0.2,
              hideOnMouseOut = FALSE)

dext_18_avg_2002_2015 <- dext_to_gdp_18 %>%
  filter(year(year) >= 2002 & year(year) <= 2015) %>% 
  group_by(iso3c) %>% 
  summarise(dext_avg_2002_2015 = mean(deuda_ext_porc_pib, rm.na = TRUE))

pctiles_50_2002_2015 <-  quantile(dext_18_avg_2002_2015$dext_avg_2002_2015,
                                  probs = c(0.5))


dext_18_avg_1990_2001_sa <- dext_18_avg_1990_2001 %>% 
  filter(iso3c %in% coi_sa)

dext_18_avg_1990_2001_ca <- dext_18_avg_1990_2001 %>% 
  filter(iso3c %in% coi_ca)



dext_18_avg_2002_2015_sa <- dext_18_avg_2002_2015 %>% 
  filter(iso3c %in% coi_sa)

dext_18_avg_2002_2015_ca <- dext_18_avg_2002_2015 %>% 
  filter(iso3c %in% coi_ca)



pctiles_50_1990_2001_sa <-  quantile(dext_18_avg_1990_2001_sa$dext_avg_1990_2001,
                                  probs = c(0.5))
pctiles_50_2002_2015_sa <-  quantile(dext_18_avg_2002_2015_sa$dext_avg_2002_2015,
                                  probs = c(0.5))

pctiles_50_1990_2001_ca <-  quantile(dext_18_avg_1990_2001_ca$dext_avg_1990_2001,
                                  probs = c(0.5))
pctiles_50_2002_2015_ca <-  quantile(dext_18_avg_2002_2015_ca$dext_avg_2002_2015,
                                  probs = c(0.5))

pctiles_33_66_1990_2001 <-  quantile(dext_18_avg_1990_2001$dext_avg_1990_2001,
                                  probs = c(0.33, 0.66))
pctiles_33_66_2002_2015 <-  quantile(dext_18_avg_2002_2015$dext_avg_2002_2015,
                                  probs = c(0.33, 0.66))

pctiles_33_66_1990_2001_sa <-  quantile(dext_18_avg_1990_2001_sa$dext_avg_1990_2001,
                                  probs = c(0.33, 0.66))
pctiles_33_66_2002_2015_sa <-  quantile(dext_18_avg_2002_2015_sa$dext_avg_2002_2015,
                                  probs = c(0.33, 0.66))

pctiles_33_66_1990_2001_ca <-  quantile(dext_18_avg_1990_2001_ca$dext_avg_1990_2001,
                                  probs = c(0.33, 0.66))
pctiles_33_66_2002_2015_ca <-  quantile(dext_18_avg_2002_2015_ca$dext_avg_2002_2015,
                                  probs = c(0.33, 0.66))

# cuts_quantile <- cut(deuda_chica$valor, quantile(deuda_chica$valor), include.lowest = TRUE)
# soo <- break_down_table(deuda_chica, cuts_vector = cuts_quantile)

dext_to_gdp_18_median_split <- break_down_table(
  dext_18_avg_1990_2001,
  cuts_vector = cut(dext_18_avg_1990_2001$dext_avg_1990_2001, 
                    pctiles_50_1990_2001,
                    include.lowest = TRUE)
  ) 
  
  
```




```{r ext_debt_make_tables, eval=FALSE, include=FALSE}

if (params$is_html == TRUE) {
print("html doc, only DT tables")
dt_dext_to_gdp <- datatable(narr_dext_to_gdp)
}


#this could be changed later to if-else chain if pdf and word become explicit options
if (params$is_html != TRUE) {
print("not an html doc, prefer kable and xtable packages, over DT")
kb_dext_to_gdp <- kable(narr_dext_to_gdp)
xt_dext_to_gdp <- xtable(narr_dext_to_gdp)
}
```


```{r ext_debt_show_tables, eval=FALSE, include=FALSE, results="asis"}

if (params$is_html == TRUE) {
dt_mr_3_dext_to_gdp
}

if (params$is_html != TRUE) {
kb_mr_3_dext_to_gdp
# dt_mr_3_dext_to_gdp
}

```


## Public debt, domestic and external:

```{r load_public_debt_data}
load("./produced_data/data_with_basic_wrangling/cs_sector_publico")
```

```{r secpub_debt_make_dfs, echo=FALSE }
sp_data <- cs_sector_publico %>% 
  filter(iso3c %in% coi) %>% 
  filter(year <= params$end_year) 

sp_deuda_porc_pib <- sp_data %>% 
  filter(`Cobertura institucional_2` != "n/a") %>%
  filter( str_detect(indicador, "porcentajes")) %>% 
  rename(cobertura =  `Cobertura institucional_2`) %>% 
  select(-c(`Tipo de persona`, Periodo, `Tasa mínima/máxima`, Periodo_1,
            `Clasificación económica Operaciones del gobierno`, 
            `Cobertura institucional_1`, `Cobertura institucional`,
            Clasificacion_impuestos)) %>% 
  rename(deuda_publica_porc_pib = valor, clasificacion_deuda = Clasificación_deuda) %>% 
  mutate(clasificacion_deuda = str_to_lower(clasificacion_deuda) %>% 
           str_replace_all(" ", "_") %>% stri_trans_general("Latin-ASCII") %>% 
           str_replace_all("\\(", "_") %>% str_replace_all("\\)", "_")
  ) %>% 
  filter(!duplicated(.[ , 1:5])) %>%  
  spread(clasificacion_deuda, deuda_publica_porc_pib) %>%
  rename(total_p = total_deuda_publica__clasificacion_por_residencia_,
         externa_p = deuda_externa,
         interna_p = deuda_interna)

gcentral_deuda_pib <- sp_deuda_porc_pib %>% 
  filter(cobertura == "Gobierno central"  ) %>% 
  select(iso3c, year, externa_p, interna_p, total_p)

sectorpublico_deuda_pib <- sp_deuda_porc_pib %>% 
  filter(cobertura == "Sector público") %>% 
  select(iso3c, year, externa_p, interna_p, total_p)

gsubnac_deuda_pib <- sp_deuda_porc_pib %>% 
  filter(cobertura == "Gobiernos subnacionales") %>% 
  select(iso3c, year, externa_p, interna_p, total_p)

gspnf_deuda_pib <- sp_deuda_porc_pib %>% 
  filter(cobertura == "Sector público no financiero") %>% 
  select(iso3c, year, externa_p, interna_p, total_p)

```

## Cartera vencida 

```{r cartera_vencida_make}
load("./produced_data/data_with_basic_wrangling/monetary_fin_tidy")
load("./produced_data/data_with_basic_wrangling/cs_gdp_currentlc_q_gasto")

cv_december <- cartera_vencida_33_tidy %>% 
  filter(year <= params$end_year) %>% 
  filter(iso3c %in% coi) %>% 
  filter( month == 12 )

cv_3_6_9_12 <- cartera_vencida_33_tidy %>% 
  filter(year <= params$end_year) %>% 
  filter(iso3c %in% coi) %>% 
  filter( month  %in%  c(3,6,9,12))

cartera_vencida_qtr_with_gdp <- cs_gdp_currentlc_q_gasto %>%
  select(-c(iso3c, nombre_pais, Rubro)) %>%
  left_join( cartera_vencida_33_tidy ,  by = c("iso2c", "date")) %>%
  filter( !is.na(cartera_vencida_percent) ) %>%
  filter(iso3c %in% coi)

mr_3_cv_anual <- cv_december %>%
  filter(!is.na(cartera_vencida_percent)) %>% 
  group_by(iso3c) %>% 
  arrange(year) %>% 
  summarise(year_mr = max(year),
            cv_mr = last(cartera_vencida_percent),
            avg_mr_3 = mean(tail(cartera_vencida_percent, 3) , rm.na = TRUE)
  ) %>% 
  arrange(desc(cv_mr)) %>% 
  mutate(rnk_mr_cv = min_rank(-cv_mr),
         rnk_mr_3_cv = min_rank(-avg_mr_3)) %>% 
  arrange(iso3c)

```


## Crédito interno

```{r credito_interno_make_dfs}
credito_interno_qtr <- cs_gdp_currentlc_q_gasto %>% 
  select(-c(iso3c, nombre_pais, Rubro)) %>% 
  left_join( credito_interno_33_tidy ,  by = c("iso2c", "date")) %>% 
  filter( !is.na(total) ) %>% 
  filter(iso3c %in% coi) %>% 
  filter(year <= params$end_year) %>% 
  mutate(total_to_gdp_seas = total/gdp_sa_seas,
         al_spub_gdp_seas = al.sector.público/gdp_sa_seas,
         al_spriv_gdp_seas = al.sector.privado/gdp_sa_seas,
         al_gob_gdp_seas = gobierno/gdp_sa_seas,
         a_otros_gdp_seas = otros/gdp_sa_seas,
         total_to_gdp_stl = total/gdp_sa_stl,
         al_spub_gdp_stl = al.sector.público/gdp_sa_stl,
         al_spriv_gdp_stl = al.sector.privado/gdp_sa_stl,
         al_gob_gdp_stl = gobierno/gdp_sa_stl,
         a_otros_gdp_stl = otros/gdp_sa_stl)


tab_ci_qrt_gdp <- credito_interno_qtr %>% 
  group_by(iso2c, year) %>%
  summarise(nobs = n(), 
            num_countries = length(unique(credito_interno_qtr$iso2c)),
            avg_spu_gdp = mean(al_spub_gdp_stl, rm.na = TRUE),
            avg_spr_gdp = mean(al_spriv_gdp_stl, rm.na = TRUE),
            avg_tot_gdp = mean(total_to_gdp_stl, rm.na = TRUE),
            avg_gob_gdp = mean(al_gob_gdp_stl, rm.na = TRUE),
            n_gob_gdp = sum(!is.na(al_gob_gdp_stl)),
            n_tot_gdp = sum(!is.na(total_to_gdp_stl)),
            n_spub_gdp = sum(!is.na(al_spub_gdp_stl)),
            n_spr_gdp = sum(!is.na(al_spriv_gdp_stl))
  )


mr_3_ci_to_gdp <- tab_ci_qrt_gdp %>% 
  group_by(iso2c) %>% 
  arrange(year) %>% 
  summarise(year_mr = max(year),
            ci_total_mr = last(avg_tot_gdp),
            avg_mr_ci_tot_3 = mean(tail(avg_tot_gdp, 3) , rm.na = TRUE),
            ci_spu_mr = last(avg_spu_gdp),
            avg_mr_ci_spu_3 = mean(tail(avg_spu_gdp, 3) , rm.na = TRUE),
            ci_spr_mr = last(avg_spr_gdp),
            avg_mr_ci_spr_3 = mean(tail(avg_spr_gdp, 3) , rm.na = TRUE)
  ) %>% 
  arrange(desc(ci_total_mr)) %>% 
  mutate(rnk_mr_tot = min_rank(-ci_total_mr),
         rnk_mr_3_tot = min_rank(-avg_mr_ci_tot_3)) %>% 
  arrange(iso2c)


```

## Préstamos Bancarios

```{r prestamos_bancarios_make_dfs}

prestamos_bancarios_qtr <- cs_gdp_currentlc_q_gasto %>% 
    select(-c(iso3c, nombre_pais, Rubro)) %>% 
    left_join(prestamos_bancarios_33_tidy,  by = c("iso2c", "date")) %>% 
    filter( !is.na(total) ) %>% 
    filter(iso3c %in% coi) %>% 
    filter(year <= params$end_year) %>% 
    mutate(total_to_gdp_stl = total/gdp_sa_stl,
           consumo_gdp_stl = consumo/gdp_sa_stl,
           hipotecario_gdp_stl = hipotecario/gdp_sa_stl,
           industrial_gdp_stl = industrial/gdp_sa_stl,
           comercial_gdp_stl = comercial/gdp_sa_stl)



tab_pb_qtr <- prestamos_bancarios_qtr %>% group_by(iso2c, year) %>% 
  group_by(iso2c, year) %>%
  filter(iso2c != "CO") %>% 
  summarise(nobs = n(), 
            num_countries = length(unique(prestamos_bancarios_qtr$iso2c)),
            avg_tot_to_gdp = mean(total_to_gdp_stl),
            avg_hip_to_gdp = mean(hipotecario_gdp_stl, rm.na=TRUE),
            avg_con_to_gdp = mean(consumo_gdp_stl, rm.na=TRUE),
            n_hip_to_gdp = sum(!is.na(hipotecario_gdp_stl)),
            n_con_to_gdp = sum(!is.na(consumo_gdp_stl))
  )



```



# Exportaciones
## Concentracion de exportaciones

Índice de Herfindahl, concentración al interior de los 10 principales productos 
de cada país, en cada año.

```{r exp_imp_make_dfs}
load("./produced_data/data_with_basic_wrangling/cs_x_m_10_ppales")


exp_10_ppales <- cs_x_m_10_ppales %>%
  filter(iso3c %in% coi) %>% 
  filter(year <= params$end_year) %>% 
  unite(productos_principales,  starts_with("Produ")) %>% 
  mutate(productos_principales = str_replace_all(productos_principales,
                                                 "_", "") %>% 
           str_replace_all("n/a", "") %>% 
           str_replace_all("NA", ""))
  
exp_10_ppales_by_iso <- exp_10_ppales %>% 
  group_by(iso3c, year) %>% 
  summarise(concentracion = conc(valor, type = "Herfindahl")) %>% 
  arrange(iso3c, year)


```

## Shares en exportaciones de 3 categorías a priori

Datos mensuales, promediados por año

```{r shares_exp_3_cat}
load("./produced_data/data_with_basic_wrangling/x_m_locations_products_tidy")

imp_by_prod_to_join <- imp_by_prod_tidy %>% 
   filter(iso3c %in% coi) %>% 
  rename(producto_m = producto) 

exp_by_prod_to_join <- exp_by_prod_tidy %>% 
   filter(iso3c %in% coi) %>% 
  rename(producto_x = producto) %>% 
  mutate(producto_x = stri_trans_general(producto_x, "Latin-ASCII") %>% 
           str_to_lower() %>% str_replace_all(" ", "_"))

exp_by_prod_wide <- exp_by_prod_to_join %>% 
   filter(iso3c %in% coi) %>% 
  spread(producto_x, value) %>% 
  mutate(agro_agropec_share = productos_agricolas_y_agropecuarios/total,
         mineria_y_petro_share = mineria_y_petroleo/total,
         manufacturas_share = manufacturas/total) %>% 
  select(-c(productos_agricolas_y_agropecuarios,mineria_y_petroleo,
            manufacturas))

exp_by_prod_wide_anual <- exp_by_prod_wide %>% 
  mutate(year = year(date)) %>% 
  group_by(iso3c, year) %>% 
  mutate(avg_share_agr = mean(agro_agropec_share, rm.na = TRUE),
         avg_share_min_pet = mean(mineria_y_petro_share, rm.na = TRUE),
         avg_share_manuf = mean(manufacturas_share, rm.na = TRUE)) %>% 
  arrange(year, desc(avg_share_min_pet))


exp_by_prod_shares <- exp_by_prod_wide_anual %>% 
  rename(agro_pec=agro_agropec_share, mineria_y_petro=mineria_y_petro_share,
         manuf=manufacturas_share) %>% 
  gather(key = product, value = share, agro_pec, mineria_y_petro, manuf ) %>% 
  select(-c(avg_share_agr, avg_share_min_pet, avg_share_manuf, total)) %>% 
  arrange(iso3c, year, product)

exp_by_prod_shares_anual_avg <- exp_by_prod_shares %>% 
  group_by(iso3c, year, product) %>% 
  summarise(share_anual = mean(share, rm.na=TRUE))


```







